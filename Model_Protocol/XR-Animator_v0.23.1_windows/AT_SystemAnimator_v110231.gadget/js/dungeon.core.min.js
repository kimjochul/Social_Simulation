// 2019-08-11

var MersenneTwister=function(c){c==void 0&&(c=new Date().getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=Array(this.N),this.mti=this.N+1,this.init_genrand(c)};MersenneTwister.prototype.init_genrand=function(c){for(this.mt[0]=c>>>0,this.mti=1;this.mti<this.N;this.mti++){var c=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30;this.mt[this.mti]=(1812433253*((4294901760&c)>>>16)<<16)+1812433253*(65535&c)+this.mti,this.mt[this.mti]>>>=0}},MersenneTwister.prototype.init_by_array=function(c,d){var e,f,g;for(this.init_genrand(19650218),e=1,f=0,g=this.N>d?this.N:d;g;g--){var h=this.mt[e-1]^this.mt[e-1]>>>30;this.mt[e]=(this.mt[e]^(1664525*((4294901760&h)>>>16)<<16)+1664525*(65535&h))+c[f]+f,this.mt[e]>>>=0,e++,f++,e>=this.N&&(this.mt[0]=this.mt[this.N-1],e=1),f>=d&&(f=0)}for(g=this.N-1;g;g--){var h=this.mt[e-1]^this.mt[e-1]>>>30;this.mt[e]=(this.mt[e]^(1566083941*((4294901760&h)>>>16)<<16)+1566083941*(65535&h))-e,this.mt[e]>>>=0,e++,e>=this.N&&(this.mt[0]=this.mt[this.N-1],e=1)}this.mt[0]=2147483648},MersenneTwister.prototype.genrand_int32=function(){var c,d=[0,this.MATRIX_A];if(this.mti>=this.N){var e;for(this.mti==this.N+1&&this.init_genrand(5489),e=0;e<this.N-this.M;e++)c=this.mt[e]&this.UPPER_MASK|this.mt[e+1]&this.LOWER_MASK,this.mt[e]=this.mt[e+this.M]^c>>>1^d[1&c];for(;e<this.N-1;e++)c=this.mt[e]&this.UPPER_MASK|this.mt[e+1]&this.LOWER_MASK,this.mt[e]=this.mt[e+(this.M-this.N)]^c>>>1^d[1&c];c=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^c>>>1^d[1&c],this.mti=0}return c=this.mt[this.mti++],c^=c>>>11,c^=2636928640&c<<7,c^=4022730752&c<<15,c^=c>>>18,c>>>0},MersenneTwister.prototype.genrand_int31=function(){return this.genrand_int32()>>>1},MersenneTwister.prototype.genrand_real1=function(){return this.genrand_int32()*(1/4294967295)},MersenneTwister.prototype.random=function(){return this.genrand_int32()*(1/4294967296)},MersenneTwister.prototype.genrand_real3=function(){return(this.genrand_int32()+0.5)*(1/4294967296)},MersenneTwister.prototype.genrand_res53=function(){var c=this.genrand_int32()>>>5,d=this.genrand_int32()>>>6;return(67108864*c+d)*(1/9007199254740992)};
(function(b){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=b();else if("function"==typeof define&&define.amd)define([],b);else{var d;d="undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?this:self:global:window,d.Dungeon=b()}})(function(){return function q(v,z,A){function B(E,F){if(!z[E]){if(!v[E]){var G="function"==typeof require&&require;if(!F&&G)return G(E,!0);if(C)return C(E,!0);var H=new Error("Cannot find module '"+E+"'");throw H.code="MODULE_NOT_FOUND",H}var I=z[E]={exports:{}};v[E][0].call(I.exports,function(J){var K=v[E][1][J];return B(K?K:J)},I,I.exports,q,v,z,A)}return z[E].exports}for(var C="function"==typeof require&&require,D=0;D<A.length;D++)B(A[D]);return B}({1:[function(q,v,z){"use strict";function A(Q,R,S){return R in Q?Object.defineProperty(Q,R,{value:S,enumerable:!0,configurable:!0,writable:!0}):Q[R]=S,Q}var B,C,D,E,F;Object.defineProperty(z,"__esModule",{value:!0});var G=z.TOP=0,H=z.RIGHT=90,I=z.BOTTOM=180,J=z.LEFT=270,K=z.FACING=[G,H,I,J],L=z.FACING_TO_STRING=(B={},A(B,G,"top"),A(B,H,"right"),A(B,I,"bottom"),A(B,J,"left"),B),M=z.FACING_TO_MOD=(C={},A(C,G,[0,-1]),A(C,H,[1,0]),A(C,I,[0,1]),A(C,J,[-1,0]),C),N=z.FACING_INVERSE=(D={},A(D,G,I),A(D,H,J),A(D,I,G),A(D,J,H),D),O=z.FACING_MOD_RIGHT=(E={},A(E,G,H),A(E,H,I),A(E,I,J),A(E,J,G),E),P=z.FACING_MOD_LEFT=(F={},A(F,G,J),A(F,H,G),A(F,I,H),A(F,J,I),F)},{}],2:[function(q,v,z){"use strict";function A(O){return O&&O.__esModule?O:{default:O}}function B(O,P){if(!(O instanceof P))throw new TypeError("Cannot call a class as a function")}function C(O,P){if(!O)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return P&&("object"==typeof P||"function"==typeof P)?P:O}function D(O,P){if("function"!=typeof P&&null!==P)throw new TypeError("Super expression must either be null or a function, not "+typeof P);O.prototype=Object.create(P&&P.prototype,{constructor:{value:O,enumerable:!1,writable:!0,configurable:!0}}),P&&(Object.setPrototypeOf?Object.setPrototypeOf(O,P):O.__proto__=P)}var E=function(){function O(P,Q){for(var S,R=0;R<Q.length;R++)S=Q[R],S.enumerable=S.enumerable||!1,S.configurable=!0,"value"in S&&(S.writable=!0),Object.defineProperty(P,S.key,S)}return function(P,Q,R){return Q&&O(P.prototype,Q),R&&O(P,R),P}}();Object.defineProperty(z,"__esModule",{value:!0});var F=q("./generator"),G=A(F),H=q("../pieces/corridor"),I=A(H),J=q("../pieces/room"),K=A(J),L=q("../const"),M=q("../utils"),N=function(O){function P(Q){B(this,P),Q=Object.assign({},{size:[100,100],rooms:{initial:{min_size:[3,3],max_size:[3,3],max_exits:1},any:{min_size:[2,2],max_size:[5,5],max_exits:4}},max_corridor_length:6,min_corridor_length:2,corridor_density:0.5,symmetric_rooms:!1,interconnects:1,max_interconnect_length:10,room_count:10},Q);var R=C(this,Object.getPrototypeOf(P).call(this,Q));R.room_tags=Object.keys(R.rooms).filter(function(T){return"any"!==T&&"initial"!==T});for(var S=R.room_tags.length;S<R.room_count;S++)R.room_tags.push("any");return R.rooms=[],R.corridors=[],R}return D(P,O),E(P,[{key:"add_room",value:function(R,S){for(var V,W,T=2>=arguments.length||void 0===arguments[2]?null:arguments[2],U=T,X=0;;){if(T)W=T,T=null;else if(V=this.get_open_pieces(this.children),V&&V.length)W=this.random.choose(V);else{console.log("ran out of choices connecting");break}if(!S){for(var Y=R.perimeter.slice();Y.length;)if(this.join(W,this.random.choose(Y,!0),R))return!0;}else if(this.join(W,S,R))return!0;if(100==X++)return console.log("failed to connect 100 times :(",R,S,U),!1}}},{key:"new_corridor",value:function(){return new I.default({length:this.random.int(this.min_corridor_length,this.max_corridor_length),facing:this.random.choose(L.FACING)})}},{key:"add_interconnect",value:function(){var S,T,U,R={};this.children.forEach(function(aa){aa.exits.length<aa.max_exits&&aa.perimeter.forEach(function(ba){U=aa.parent_pos(ba[0]),S=U[0]+"_"+U[1],R[S]=[ba,aa]})});for(var V=void 0,X=void 0,Y=void 0,Z=void 0,$=this.children.length-1;$--;0<=$)if(V=this.children[$],V.exits.length<V.max_exits)for(var _=0;_<V.perimeter.length;_++)for(T=V.perimeter[_],U=V.parent_pos(T[0]),X=-1;X<=this.max_interconnect_length&&this.walls.get(U)&&this.walls.get((0,M.shift_left)(U,T[1]))&&this.walls.get((0,M.shift_right)(U,T[1]));){if(S=U[0]+"_"+U[1],R[S]&&R[S][1].id!==V.id)return Z=R[S][1],-1<X?(Y=new I.default({length:X,facing:T[1]}),!!this.join(V,Y.perimeter[0],Y,T)&&(this.join_exits(Z,R[S][0],Y,Y.perimeter[Y.perimeter.length-1]),!0)):(this.join_exits(Z,R[S][0],V,T),!0);U=(0,M.shift)(U,T[1]),X++}}},{key:"new_room",value:function(R){R=R||this.random.choose(this.room_tags,!1);var S=this.options.rooms[R],T=new K.default({size:this.random.vec(S.min_size,S.max_size),max_exits:S.max_exits,symmetric:this.symmetric_rooms,tag:R});return this.room_tags.splice(this.room_tags.indexOf(R),1),"initial"===R&&(this.initial_room=T),T}},{key:"generate",value:function(){var R=this.options.room_count-1,S=this.new_room(this.options.rooms.initial?"initial":void 0),T=Math.round(this.corridor_density*R);this.add_piece(S,this.options.rooms.initial&&this.options.rooms.initial.position?this.options.rooms.initial.position:this.get_center_pos());for(var U;T||R;)if(U=this.random.int(1,R+T),U<=T){var V=this.new_corridor(),W=this.add_room(V,V.perimeter[0]);T--,0<R&&W&&(this.add_room(this.new_room(),null,V),R--)}else this.add_room(this.new_room()),R--;for(U=0;U<this.interconnects;U++)this.add_interconnect();this.trim(),this.initial_room&&(this.start_pos=this.initial_room.global_pos(this.initial_room.get_center_pos()))}}]),P}(G.default);z.default=N},{"../const":1,"../pieces/corridor":4,"../pieces/room":6,"../utils":8,"./generator":3}],3:[function(q,v,z){"use strict";function A(O){return O&&O.__esModule?O:{default:O}}function B(O,P){if(!(O instanceof P))throw new TypeError("Cannot call a class as a function")}function C(O,P){if(!O)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return P&&("object"==typeof P||"function"==typeof P)?P:O}function D(O,P){if("function"!=typeof P&&null!==P)throw new TypeError("Super expression must either be null or a function, not "+typeof P);O.prototype=Object.create(P&&P.prototype,{constructor:{value:O,enumerable:!1,writable:!0,configurable:!0}}),P&&(Object.setPrototypeOf?Object.setPrototypeOf(O,P):O.__proto__=P)}var E=function(){function O(P,Q){for(var S,R=0;R<Q.length;R++)S=Q[R],S.enumerable=S.enumerable||!1,S.configurable=!0,"value"in S&&(S.writable=!0),Object.defineProperty(P,S.key,S)}return function(P,Q,R){return Q&&O(P.prototype,Q),R&&O(P,R),P}}(),F=function O(P,Q,R){null===P&&(P=Function.prototype);var S=Object.getOwnPropertyDescriptor(P,Q);if(S===void 0){var T=Object.getPrototypeOf(P);return null===T?void 0:O(T,Q,R)}if("value"in S)return S.value;var U=S.get;return void 0===U?void 0:U.call(R)};Object.defineProperty(z,"__esModule",{value:!0});var G=q("../utils/random"),H=A(G),I=q("../pieces/piece"),J=A(I),K=q("../utils/rectangle"),L=A(K),M=q("../const"),N=function(O){function P(Q){B(this,P);var R=C(this,Object.getPrototypeOf(P).call(this,Q));return R.random=new H.default(R.seed),R.start_pos=[0,0],R.minx=R.size[0],R.maxx=0,R.miny=R.size[1],R.maxy=0,R}return D(P,O),E(P,[{key:"add_piece",value:function(R,S){F(Object.getPrototypeOf(P.prototype),"add_piece",this).call(this,R,S),this.minx=Math.min(this.minx,R.position[0]),this.maxx=Math.max(this.maxx,R.position[0]+R.size[0]),this.miny=Math.min(this.miny,R.position[1]),this.maxy=Math.max(this.maxy,R.position[1]+R.size[1])}},{key:"trim",value:function(){var R=this;this.size=[this.maxx-this.minx,this.maxy-this.miny],this.children.forEach(function(S){S.position=[S.position[0]-R.minx,S.position[1]-R.miny]}),this.start_pos=[this.start_pos[0]-this.minx,this.start_pos[1]-this.miny],this.walls=this.walls.get_square([this.minx,this.miny],this.size),this.minx=0,this.maxx=this.size[0],this.miny=0,this.maxy=this.size[1]}},{key:"generate",value:function(){throw new Error("not implemented")}},{key:"fits",value:function(R,S){var T,U,V;for(U=0;U<R.size[0];U++)for(V=0;V<R.size[1];V++)if(T=this.walls.get([S[0]+U,S[1]+V]),!1===T||null===T||void 0==T)return!1;return!0}},{key:"join_exits",value:function(R,S,T,U){R.add_exit(S,T),T.add_exit(U,R);var V=R.rect.intersection(T.rect);V&&(R.remove_perimeter(new L.default(R.local_pos([V[0],V[1]],[V.width,V.height]))),T.remove_perimeter(new L.default(T.local_pos([V[0],V[1]],[V.width,V.height]))))}},{key:"join",value:function(R,S,T,U){U||(U=this.random.choose(R.get_perimeter_by_facing(M.FACING_INVERSE[S[1]])));var V=R.parent_pos(U[0]),W=[V[0]-S[0][0],V[1]-S[0][1]];return!!this.fits(T,W)&&(this.join_exits(R,U,T,S),this.add_piece(T,W),!0)}},{key:"get_open_pieces",value:function(R){return R.filter(function(S){return S.exits.length<S.max_exits&&S.perimeter.length})}}]),P}(J.default);z.default=N},{"../const":1,"../pieces/piece":5,"../utils/random":9,"../utils/rectangle":10}],4:[function(q,v,z){"use strict";function B(H,I){if(!(H instanceof I))throw new TypeError("Cannot call a class as a function")}function C(H,I){if(!H)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return I&&("object"==typeof I||"function"==typeof I)?I:H}function D(H,I){if("function"!=typeof I&&null!==I)throw new TypeError("Super expression must either be null or a function, not "+typeof I);H.prototype=Object.create(I&&I.prototype,{constructor:{value:H,enumerable:!1,writable:!0,configurable:!0}}),I&&(Object.setPrototypeOf?Object.setPrototypeOf(H,I):H.__proto__=I)}Object.defineProperty(z,"__esModule",{value:!0});var E=q("./room"),F=function(H){return H&&H.__esModule?H:{default:H}}(E),G=function(H){function I(J){B(this,I),J=Object.assign({},{length:2,facing:0,max_exits:4},J),J.size=0===J.facing||180===J.facing?[1,J.length]:[J.length,1];var K=C(this,Object.getPrototypeOf(I).call(this,J)),L=K.size[0]-1,M=K.size[1]-1;return 180===K.facing?K.perimeter=[[[1,M],0],[[0,1],90],[[2,1],270],[[1,0],180]]:270===K.facing?K.perimeter=[[[0,1],90],[[L-1,0],180],[[L-1,2],0],[[L,1],270]]:0===K.facing?K.perimeter=[[[1,0],180],[[2,M-1],270],[[0,M-1],90],[[1,M],0]]:90===K.facing&&(K.perimeter=[[[L,1],270],[[1,2],0],[[1,0],180],[[0,1],90]]),K}return D(I,H),I}(F.default);z.default=G},{"./room":6}],5:[function(q,v,z){"use strict";function A(M){return M&&M.__esModule?M:{default:M}}function B(M){return Array.isArray(M)?M:Array.from(M)}function C(M,N){if(!(M instanceof N))throw new TypeError("Cannot call a class as a function")}var D=function(){function M(N,O){var P=[],Q=!0,R=!1,S;try{for(var U,T=N[Symbol.iterator]();!(Q=(U=T.next()).done)&&(P.push(U.value),!(O&&P.length===O));Q=!0);}catch(V){R=!0,S=V}finally{try{!Q&&T["return"]&&T["return"]()}finally{if(R)throw S}}return P}return function(N,O){if(Array.isArray(N))return N;if(Symbol.iterator in Object(N))return M(N,O);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),E=function(){function M(N,O){for(var Q,P=0;P<O.length;P++)Q=O[P],Q.enumerable=Q.enumerable||!1,Q.configurable=!0,"value"in Q&&(Q.writable=!0),Object.defineProperty(N,Q.key,Q)}return function(N,O,P){return O&&M(N.prototype,O),P&&M(N,P),N}}();Object.defineProperty(z,"__esModule",{value:!0});var F=q("../utils/array2d"),G=A(F),H=q("../utils/rectangle"),I=A(H),J=q("../utils"),K=0,L=function(){function M(N){C(this,M),N=Object.assign({size:[1,1],position:[0,0],parent:null,max_exits:10,tag:""},N),Object.assign(this,N),this.options=N,this.id=K++,this.walls=new G.default(this.size,!0),this.perimeter=[],this.exits=[],this.children=[]}return E(M,[{key:"is_exit",value:function(O){var P=D(O,2),Q=P[0],R=P[1];return 0!==this.exits.filter(function(S){var T=B(S),U=T[0],V=T[1],W=T.slice(2);return U===Q&&V===R}).length}},{key:"get_non_wall_tiles",value:function(){var O=[];return this.walls.iter(function(P,Q){Q||O.push(P)}),O}},{key:"get_perimeter_by_facing",value:function(O){return this.perimeter.filter(function(P){var Q=D(P,2),R=D(Q[0],2),S=R[0],T=R[1],U=Q[1];return O===U})}},{key:"get_inner_perimeter",value:function(){var Q,R,O=this,P=[];return this.walls.iter(function(S,T){T||O.is_exit(S)||(Q=!1,R=!1,(0,J.iter_adjacent)(S,function(U){Q=Q||O.walls.get(U),R=R||O.is_exit(U)}),Q&&!R&&P.push(S))}),P}},{key:"parent_pos",value:function(O){var P=D(O,2),Q=P[0],R=P[1];return[this.position[0]+Q,this.position[1]+R]}},{key:"global_pos",value:function(O){return O=this.parent_pos(O),this.parent&&(O=this.parent.global_pos(O)),O}},{key:"local_pos",value:function(O){return[O[0]-this.position[0],O[1]-this.position[1]]}},{key:"get_center_pos",value:function(){return[Math.floor(this.size[0]/2),Math.floor(this.size[1]/2)]}},{key:"add_perimeter",value:function(O,P,Q){var R=this;(0,J.iter_range)(O,P,function(S){R.perimeter.push([S,Q])})}},{key:"remove_perimeter",value:function(O){this.perimeter=this.perimeter.filter(function(P){var Q=D(P,3),R=Q[0],S=Q[1],T=Q[2];return!O.contains(R,S,1,1)})}},{key:"intersects",value:function(O){return(0,J.intersects)(this.position,this.size,O.position,O.size)}},{key:"add_piece",value:function(O){var P=1>=arguments.length||void 0===arguments[1]?null:arguments[1];(0,J.array_test)(this.children,function(Q){return Q.id===O.id})||(O.parent=this,P&&(O.position=P),this.children.push(O),this.paste_in(O))}},{key:"paste_in",value:function(O){var P=this;(0,J.iter_2d)(O.size,function(Q){var R=O.walls.get(Q);R||P.walls.set(O.parent_pos(Q),!1)})}},{key:"add_exit",value:function(O,P){this.walls.set(O[0],!1),this.parent&&this.parent.paste_in(this),this.exits.push([O[0],O[1],P])}},{key:"print",value:function(){for(var P,O=0;O<this.size[1];O++){P="";for(var Q=0;Q<this.size[0];Q++)P+=this.start_pos&&this.start_pos[0]===Q&&this.start_pos[1]===O?"s":this.walls.get([Q,O])?"x":" ";console.log(P)}}},{key:"rect",get:function(){return new I.default(this.position[0],this.position[1],this.size[0],this.size[1])}}]),M}();z.default=L},{"../utils":8,"../utils/array2d":7,"../utils/rectangle":10}],6:[function(q,v,z){"use strict";function B(J,K){if(!(J instanceof K))throw new TypeError("Cannot call a class as a function")}function C(J,K){if(!J)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return K&&("object"==typeof K||"function"==typeof K)?K:J}function D(J,K){if("function"!=typeof K&&null!==K)throw new TypeError("Super expression must either be null or a function, not "+typeof K);J.prototype=Object.create(K&&K.prototype,{constructor:{value:J,enumerable:!1,writable:!0,configurable:!0}}),K&&(Object.setPrototypeOf?Object.setPrototypeOf(J,K):J.__proto__=K)}var E=function(){function J(K,L){var M=[],N=!0,O=!1,P;try{for(var R,Q=K[Symbol.iterator]();!(N=(R=Q.next()).done)&&(M.push(R.value),!(L&&M.length===L));N=!0);}catch(S){O=!0,P=S}finally{try{!N&&Q["return"]&&Q["return"]()}finally{if(O)throw P}}return M}return function(K,L){if(Array.isArray(K))return K;if(Symbol.iterator in Object(K))return J(K,L);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();Object.defineProperty(z,"__esModule",{value:!0});var F=q("./piece"),G=function(J){return J&&J.__esModule?J:{default:J}}(F),H=q("../utils"),I=function(J){function K(L){B(this,K),L.room_size=L.size,L.size=[L.size[0]+2,L.size[1]+2],L=Object.assign({},{symmetric:!1},L);var M=C(this,Object.getPrototypeOf(K).call(this,L));if(M.walls.set_square([1,1],M.room_size,!1,!0),!M.symmetric)M.add_perimeter([1,0],[M.size[0]-2,0],180),M.add_perimeter([0,1],[0,M.size[1]-2],90),M.add_perimeter([1,M.size[1]-1],[M.size[0]-2,M.size[1]-1],0),M.add_perimeter([M.size[0]-1,1],[M.size[0]-1,M.size[1]-2],270);else{var N=M.get_center_pos(),O=E(N,2),P=O[0],Q=O[1];M.perimeter=[[[P,0],180],[[M.size[0]-1,Q],270],[[P,M.size[1]-1],0],[[0,Q],90]]}return M}return D(K,J),K}(G.default);z.default=I},{"../utils":8,"./piece":5}],7:[function(q,v,z){"use strict";function A(E,F){if(!(E instanceof F))throw new TypeError("Cannot call a class as a function")}var B=function(){function E(F,G){var H=[],I=!0,J=!1,K;try{for(var M,L=F[Symbol.iterator]();!(I=(M=L.next()).done)&&(H.push(M.value),!(G&&H.length===G));I=!0);}catch(N){J=!0,K=N}finally{try{!I&&L["return"]&&L["return"]()}finally{if(J)throw K}}return H}return function(F,G){if(Array.isArray(F))return F;if(Symbol.iterator in Object(F))return E(F,G);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),C=function(){function E(F,G){for(var I,H=0;H<G.length;H++)I=G[H],I.enumerable=I.enumerable||!1,I.configurable=!0,"value"in I&&(I.writable=!0),Object.defineProperty(F,I.key,I)}return function(F,G,H){return G&&E(F.prototype,G),H&&E(F,H),F}}();Object.defineProperty(z,"__esModule",{value:!0});var D=function(){function E(){var F=0>=arguments.length||void 0===arguments[0]?[0,0]:arguments[0],G=1>=arguments.length||void 0===arguments[1]?null:arguments[1];A(this,E),this.rows=[],this.size=[];for(var I,H=0;H<F[1];H++){I=[];for(var J=0;J<F[0];J++)I.push(G);this.rows.push(I)}}return C(E,[{key:"iter",value:function(G,H){for(var I=0;I<size[1];I++)for(var J=0;J<size[0];J++)G.apply(H,[[J,I],this.get([J,I])])}},{key:"get",value:function(G){var H=B(G,2),I=H[0],J=H[1];return void 0===this.rows[J]?void 0:this.rows[J][I]}},{key:"set",value:function(G,H){var I=B(G,2),J=I[0],K=I[1];this.rows[K][J]=H}},{key:"set_horizontal_line",value:function(G,H,I){for(var J=B(G,2),K=J[0],L=J[1],M=Math.abs(H),N=0>H?-1:1,O=0;O<=M;O++)this.set([pos[0]+O*N,pos[1]],I)}},{key:"set_vertical_line",value:function(G,H,I){for(var J=B(G,2),K=J[0],L=J[1],M=Math.abs(H),N=0>H?-1:1,O=0;O<=M;O++)this.set([pos[0],pos[1]+O*N],I)}},{key:"get_square",value:function(G,H){for(var I=B(G,2),J=I[0],K=I[1],L=B(H,2),M=L[0],N=L[1],O=new E([M,N]),P=0;P<M;P++)for(var Q=0;Q<N;Q++)O.set([P,Q],this.get([J+P,K+Q]));return O}},{key:"set_square",value:function(G,H,I){var J=B(G,2),K=J[0],L=J[1],M=B(H,2),N=M[0],O=M[1],P=3>=arguments.length||void 0===arguments[3]?!1:arguments[3];if(!P)this.line_h([K,L],N-1,I),this.line_h([K,L+O-1],N-1,I),this.line_v([K,L],O-1,I),this.line_v([K+N-1,L],O-1,I);else for(var Q=0;Q<N;Q++)for(var R=0;R<O;R++)this.set([K+Q,L+R],I)}}]),E}();z.default=D},{}],8:[function(q,v,z){"use strict";function F(L,M){return[L[0]+M[0],L[1]+M[1]]}function G(L,M){return F(L,K.FACING_TO_MOD[M])}var J=function(){function L(M,N){var O=[],P=!0,Q=!1,R;try{for(var T,S=M[Symbol.iterator]();!(P=(T=S.next()).done)&&(O.push(T.value),!(N&&O.length===N));P=!0);}catch(U){Q=!0,R=U}finally{try{!P&&S["return"]&&S["return"]()}finally{if(Q)throw R}}return O}return function(M,N){if(Array.isArray(M))return M;if(Symbol.iterator in Object(M))return L(M,N);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();Object.defineProperty(z,"__esModule",{value:!0}),z.iter_adjacent=function(L,M){var N=J(L,2),O=N[0],P=N[1];M([O-1,P]),M([O,P-1]),M([O+1,P]),M([O,P+1])},z.iter_2d=function(L,M){for(var N=0;N<L[1];N++)for(var O=0;O<L[0];O++)M([O,N])},z.iter_range=function(L,M,N){var O,P,Q,R;L[0]<M[0]?(O=L[0],Q=M[0]):(O=M[0],Q=L[0]);L[1]<M[1]?(P=L[1],R=M[1]):(P=M[1],R=L[1]);for(var S=O;S<=Q;S++)for(var T=P;T<=R;T++)N([S,T])},z.intersects=function(L,M,N,O){return!N[0]>L[0]+M[0]||N[0]+O[0]<L[0]||N[1]>L[1]+M[1]||N[1]+O[1]<M[1]},z.array_test=function(L,M){for(var N=0;N<L.length;N++)if(M(L[N]))return!0;return!1},z.add=F,z.shift=G,z.shift_left=function(L,M){return G(L,(M-90+360)%360)},z.shift_right=function(L,M){return G(L,(M+90+360)%360)};var K=q("../const")},{"../const":1}],9:[function(q,v,z){"use strict";function B(G,H){if(!(G instanceof H))throw new TypeError("Cannot call a class as a function")}var C=function(){function G(H,I){for(var K,J=0;J<I.length;J++)K=I[J],K.enumerable=K.enumerable||!1,K.configurable=!0,"value"in K&&(K.writable=!0),Object.defineProperty(H,K.key,K)}return function(H,I,J){return I&&G(H.prototype,I),J&&G(H,J),H}}();Object.defineProperty(z,"__esModule",{value:!0});var D=q("random-seed"),E=function(G){return G&&G.__esModule?G:{default:G}}(D),F=function(){function G(H){B(this,G),this.rng=E.default.create(H)}return C(G,[{key:"int",value:function(I,J){return this.rng.intBetween(I,J)}},{key:"float",value:function(){var I=0>=arguments.length||void 0===arguments[0]?0:arguments[0],J=1>=arguments.length||void 0===arguments[1]?1:arguments[1];return this.rng.floatBetween(I,J)}},{key:"vec",value:function(I,J){return[this.int(I[0],J[0]),this.int(I[1],J[1])]}},{key:"choose",value:function(I){var J=1>=arguments.length||void 0===arguments[1]?!1:arguments[1],K=this.rng.intBetween(0,I.length-1);return J?I.splice(K,1)[0]:I[K]}},{key:"maybe",value:function(I){return this.float()<=I}}]),G}();z.default=F},{"random-seed":13}],10:[function(q,v,z){"use strict";function A(D,E,F,G){if(Array.isArray(D)&&Array.isArray(E)){var H=E,I=B(H,2);F=I[0],G=I[1];var J=D,K=B(J,2);D=K[0],E=K[1]}this.setValues(D,E,F,G)}var B=function(){function D(E,F){var G=[],H=!0,I=!1,J;try{for(var L,K=E[Symbol.iterator]();!(H=(L=K.next()).done)&&(G.push(L.value),!(F&&G.length===F));H=!0);}catch(M){I=!0,J=M}finally{try{!H&&K["return"]&&K["return"]()}finally{if(I)throw J}}return G}return function(E,F){if(Array.isArray(E))return E;if(Symbol.iterator in Object(E))return D(E,F);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();Object.defineProperty(z,"__esModule",{value:!0});var C=A.prototype;C.setValues=function(D,E,F,G){return this.x=D||0,this.y=E||0,this.width=F||0,this.height=G||0,this},C.extend=function(D,E,F,G){return F=F||0,G=G||0,D+F>this.x+this.width&&(this.width=D+F-this.x),E+G>this.y+this.height&&(this.height=E+G-this.y),D<this.x&&(this.width+=this.x-D,this.x=D),E<this.y&&(this.height+=this.y-E,this.y=E),this},C.pad=function(D,E,F,G){return this.x-=E,this.y-=D,this.width+=E+G,this.height+=D+F,this},C.copy=function(D){return this.setValues(D.x,D.y,D.width,D.height)},C.contains=function(D,E,F,G){return F=F||0,G=G||0,D>=this.x&&D+F<=this.x+this.width&&E>=this.y&&E+G<=this.y+this.height},C.union=function(D){return this.clone().extend(D.x,D.y,D.width,D.height)},C.intersection=function(D){var E=D.x,F=D.y,G=E+D.width,H=F+D.height;return this.x>E&&(E=this.x),this.y>F&&(F=this.y),this.x+this.width<G&&(G=this.x+this.width),this.y+this.height<H&&(H=this.y+this.height),G<=E||H<=F?null:new A(E,F,G-E,H-F)},C.intersects=function(D){return D.x<=this.x+this.width&&this.x<=D.x+D.width&&D.y<=this.y+this.height&&this.y<=D.y+D.height},C.isEmpty=function(){return 0>=this.width||0>=this.height},C.clone=function(){return new A(this.x,this.y,this.width,this.height)},C.toString=function(){return"[Rectangle (x="+this.x+" y="+this.y+" width="+this.width+" height="+this.height+")]"},z.default=A},{}],11:[function(q,v){v.exports=q("./lib/generators/dungeon").default},{"./lib/generators/dungeon":2}],12:[function(q,v,z){function B(C,D){var E=[],F=[];return null==D&&(D=function(G,H){return E[0]===H?"[Circular ~]":"[Circular ~."+F.slice(0,E.indexOf(H)).join(".")+"]"}),function(G,H){if(0<E.length){var I=E.indexOf(this);~I?E.splice(I+1):E.push(this),~I?F.splice(I,Infinity,G):F.push(G),~E.indexOf(H)&&(H=D.call(this,G,H))}else E.push(H);return null==C?H:C.call(this,G,H)}}z=v.exports=function(C,D,E,F){return JSON.stringify(C,B(D,F),E)},z.getSerialize=B},{}],13:[function(q,v){"use strict";var A=q("json-stringify-safe"),B=function(){var D=4022871197;return function(F){if(F){F=F.toString();for(var G=0;G<F.length;G++){D+=F.charCodeAt(G);var H=0.02519603282416938*D;D=H>>>0,H-=D,H*=D,D=H>>>0,H-=D,D+=4294967296*H}return 2.3283064365386963e-10*(D>>>0)}D=4022871197}},C=function(D){return function(){var I,J,E=48,F=1,G=E,H=Array(E),K=0,L=new B;for(I=0;I<E;I++)H[I]=L(MT.random());var M=function(){++G>=E&&(G=0);var P=1768863*H[G]+2.3283064365386963e-10*F;return H[G]=P-(F=0|P)},N=function(P){return Math.floor(P*(M()+1.1102230246251565e-16*(0|2097152*M())))};N.string=function(P){var Q,R="";for(Q=0;Q<P;Q++)R+=String.fromCharCode(33+N(94));return R};var O=function(){var P=Array.prototype.slice.call(arguments);for(I=0;I<P.length;I++)for(J=0;J<E;J++)H[J]-=L(P[I]),0>H[J]&&(H[J]+=1)};return N.cleanString=function(P){return P=P.replace(/(^\s*)|(\s*$)/gi,""),P=P.replace(/[\x00-\x1F]/gi,""),P=P.replace(/\n /,"\n"),P},N.hashString=function(P){for(P=N.cleanString(P),L(P),I=0;I<P.length;I++)for(K=P.charCodeAt(I),J=0;J<E;J++)H[J]-=L(K),0>H[J]&&(H[J]+=1)},N.seed=function(P){("undefined"==typeof P||null===P)&&(P=MT.random()),"string"!=typeof P&&(P=A(P,function(Q,R){return"function"==typeof R?R.toString():R})),N.initState(),N.hashString(P)},N.addEntropy=function(){var P=[];for(I=0;I<arguments.length;I++)P.push(arguments[I]);O(K++ +new Date().getTime()+P.join("")+MT.random())},N.initState=function(){for(L(),I=0;I<E;I++)H[I]=L(" ");F=1,G=E},N.done=function(){L=null},"undefined"!=typeof D&&N.seed(D),N.range=function(P){return N(P)},N.random=function(){return N(Number.MAX_VALUE-1)/Number.MAX_VALUE},N.floatBetween=function(P,Q){return N.random()*(Q-P)+P},N.intBetween=function(P,Q){return Math.floor(N.random()*(Q-P+1))+P},N}()};C.create=function(D){return new C(D)},v.exports=C},{"json-stringify-safe":12}]},{},[11])(11)});
(function(){function f(u){for(var w=1;w<u;)w<<=1;return w}function g(u,w){if(u&u-1)throw new Error('Expected terrain size to be a power of 2, received '+u+' instead.');var z=h(u+1);return k(z,w),z}function h(u){for(var A,w=[],z=0;z<u;z++){A=[];for(var B=0;B<u;++B)A.push(0);w.push(A)}return w}function k(u,w){for(var z=0,A=Math.log(u.length-1)/Math.LN2;z++<A;)l(u,z,w),m(u,z,w)}function l(u,w,z){for(var A=u.length,B=A-1,D=B/(1<<w-1),E=D/2,F=0;F<B;F+=D)for(var G=0;G<B;G+=D){var H=[F,G],I=[F+D,G],J=[F+E,G+E],K=[F,G+D],L=[F+D,G+D],M=[H,I,K,L].map(function(P){return u[P[1]][P[0]]}),N=q(M),O=p(z,w);u[J[1]][J[0]]=N+O}}function m(u,w,z){for(var A=u.length,B=A-1,D=B/(1<<w-1),E=D/2,F=0;F<B;F+=D)for(var G=0;G<B;G+=D){var H=[F,G],I=[F+E,G],J=[F+D,G],K=[F,G+E],L=[F+E,G+E],M=[F+D,G+E],N=[F,G+D],O=[F+E,G+D],P=[F+D,G+D],Q=[F+3*E,G+E];Q[0]>B&&(Q[0]=E);var R=[F-E,G+E];0>R[0]&&(R[0]=B-E);var S=[F+E,G+3*E];S[1]>B&&(S[1]=E);var T=[F+E,G-E];0>T[1]&&(T[1]=B-E),o(u,w,z,H,L,N,R,K),o(u,w,z,H,T,J,L,I),o(u,w,z,J,Q,P,L,M),o(u,w,z,N,L,P,S,O)}for(var G=0;G<B;G+=D)u[G][B]=u[G][0];for(var F=0;F<B;F+=D)u[B][F]=u[0][F]}function o(u,w,z,A,B,C,D,E){var F=[A,B,C,D].map(function(I){return u[I[1]][I[0]]}),G=q(F),H=p(z,w);u[E[1]][E[0]]=G+H}function p(u,w){for(var z=0.5<r.random()?1:-1,A=1,B=0;B<w;++B)A*=Math.pow(2,-u);return z*r.random()*A}function q(u){var w=0;return u.forEach(function(z){w+=z}),w/u.length}var r=Math,s;s='undefined'!=typeof exports&&null!==exports?exports:window,s.generateTerrain=function(u,w,z){for(var z='undefined'==typeof z?1:z,A=f(Math.max(u,w)),B=g(A,z),C=[],D=0;D<=w;++D)C.push(B[D].slice(0,u+1));return C}}).call(this);

!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var i;i="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,i.rbush=t()}}(function(){return function t(i,n,e){function r(h,o){if(!n[h]){if(!i[h]){var s="function"==typeof require&&require;if(!o&&s)return s(h,!0);if(a)return a(h,!0);var l=new Error("Cannot find module '"+h+"'");throw l.code="MODULE_NOT_FOUND",l}var f=n[h]={exports:{}};i[h][0].call(f.exports,function(t){var n=i[h][1][t];return r(n?n:t)},f,f.exports,t,i,n,e)}return n[h].exports}for(var a="function"==typeof require&&require,h=0;h<e.length;h++)r(e[h]);return r}({1:[function(t,i,n){"use strict";function e(t,i){return this instanceof e?(this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),i&&this._initFormat(i),void this.clear()):new e(t,i)}function r(t,i,n){if(!n)return i.indexOf(t);for(var e=0;e<i.length;e++)if(n(t,i[e]))return e;return-1}function a(t,i){h(t,0,t.children.length,i,t)}function h(t,i,n,e,r){r||(r=p(null)),r.minX=1/0,r.minY=1/0,r.maxX=-(1/0),r.maxY=-(1/0);for(var a,h=i;h<n;h++)a=t.children[h],o(r,t.leaf?e(a):a);return r}function o(t,i){return t.minX=Math.min(t.minX,i.minX),t.minY=Math.min(t.minY,i.minY),t.maxX=Math.max(t.maxX,i.maxX),t.maxY=Math.max(t.maxY,i.maxY),t}function s(t,i){return t.minX-i.minX}function l(t,i){return t.minY-i.minY}function f(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function u(t){return t.maxX-t.minX+(t.maxY-t.minY)}function c(t,i){return(Math.max(i.maxX,t.maxX)-Math.min(i.minX,t.minX))*(Math.max(i.maxY,t.maxY)-Math.min(i.minY,t.minY))}function m(t,i){var n=Math.max(t.minX,i.minX),e=Math.max(t.minY,i.minY),r=Math.min(t.maxX,i.maxX),a=Math.min(t.maxY,i.maxY);return Math.max(0,r-n)*Math.max(0,a-e)}function d(t,i){return t.minX<=i.minX&&t.minY<=i.minY&&i.maxX<=t.maxX&&i.maxY<=t.maxY}function x(t,i){return i.minX<=t.maxX&&i.minY<=t.maxY&&i.maxX>=t.minX&&i.maxY>=t.minY}function p(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-(1/0),maxY:-(1/0)}}function M(t,i,n,e,r){for(var a,h=[i,n];h.length;)n=h.pop(),i=h.pop(),n-i<=e||(a=i+Math.ceil((n-i)/e/2)*e,g(t,a,i,n,r),h.push(i,a,a,n))}i.exports=e;var g=t("quickselect");e.prototype={all:function(){return this._all(this.data,[])},search:function(t){var i=this.data,n=[],e=this.toBBox;if(!x(t,i))return n;for(var r,a,h,o,s=[];i;){for(r=0,a=i.children.length;r<a;r++)h=i.children[r],o=i.leaf?e(h):h,x(t,o)&&(i.leaf?n.push(h):d(t,o)?this._all(h,n):s.push(h));i=s.pop()}return n},collides:function(t){var i=this.data,n=this.toBBox;if(!x(t,i))return!1;for(var e,r,a,h,o=[];i;){for(e=0,r=i.children.length;e<r;e++)if(a=i.children[e],h=i.leaf?n(a):a,x(t,h)){if(i.leaf||d(t,h))return!0;o.push(a)}i=o.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var i=0,n=t.length;i<n;i++)this.insert(t[i]);return this}var e=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){var r=this.data;this.data=e,e=r}this._insert(e,this.data.height-e.height-1,!0)}else this.data=e;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=p([]),this},remove:function(t,i){if(!t)return this;for(var n,e,a,h,o=this.data,s=this.toBBox(t),l=[],f=[];o||l.length;){if(o||(o=l.pop(),e=l[l.length-1],n=f.pop(),h=!0),o.leaf&&(a=r(t,o.children,i),a!==-1))return o.children.splice(a,1),l.push(o),this._condense(l),this;h||o.leaf||!d(o,s)?e?(n++,o=e.children[n],h=!1):o=null:(l.push(o),f.push(n),n=0,e=o,o=o.children[0])}return this},toBBox:function(t){return t},compareMinX:s,compareMinY:l,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,i){for(var n=[];t;)t.leaf?i.push.apply(i,t.children):n.push.apply(n,t.children),t=n.pop();return i},_build:function(t,i,n,e){var r,h=n-i+1,o=this._maxEntries;if(h<=o)return r=p(t.slice(i,n+1)),a(r,this.toBBox),r;e||(e=Math.ceil(Math.log(h)/Math.log(o)),o=Math.ceil(h/Math.pow(o,e-1))),r=p([]),r.leaf=!1,r.height=e;var s,l,f,u,c=Math.ceil(h/o),m=c*Math.ceil(Math.sqrt(o));for(M(t,i,n,m,this.compareMinX),s=i;s<=n;s+=m)for(f=Math.min(s+m-1,n),M(t,s,f,c,this.compareMinY),l=s;l<=f;l+=c)u=Math.min(l+c-1,f),r.children.push(this._build(t,l,u,e-1));return a(r,this.toBBox),r},_chooseSubtree:function(t,i,n,e){for(var r,a,h,o,s,l,u,m;;){if(e.push(i),i.leaf||e.length-1===n)break;for(u=m=1/0,r=0,a=i.children.length;r<a;r++)h=i.children[r],s=f(h),l=c(t,h)-s,l<m?(m=l,u=s<u?s:u,o=h):l===m&&s<u&&(u=s,o=h);i=o||i.children[0]}return i},_insert:function(t,i,n){var e=this.toBBox,r=n?t:e(t),a=[],h=this._chooseSubtree(r,this.data,i,a);for(h.children.push(t),o(h,r);i>=0&&a[i].children.length>this._maxEntries;)this._split(a,i),i--;this._adjustParentBBoxes(r,a,i)},_split:function(t,i){var n=t[i],e=n.children.length,r=this._minEntries;this._chooseSplitAxis(n,r,e);var h=this._chooseSplitIndex(n,r,e),o=p(n.children.splice(h,n.children.length-h));o.height=n.height,o.leaf=n.leaf,a(n,this.toBBox),a(o,this.toBBox),i?t[i-1].children.push(o):this._splitRoot(n,o)},_splitRoot:function(t,i){this.data=p([t,i]),this.data.height=t.height+1,this.data.leaf=!1,a(this.data,this.toBBox)},_chooseSplitIndex:function(t,i,n){var e,r,a,o,s,l,u,c;for(l=u=1/0,e=i;e<=n-i;e++)r=h(t,0,e,this.toBBox),a=h(t,e,n,this.toBBox),o=m(r,a),s=f(r)+f(a),o<l?(l=o,c=e,u=s<u?s:u):o===l&&s<u&&(u=s,c=e);return c},_chooseSplitAxis:function(t,i,n){var e=t.leaf?this.compareMinX:s,r=t.leaf?this.compareMinY:l,a=this._allDistMargin(t,i,n,e),h=this._allDistMargin(t,i,n,r);a<h&&t.children.sort(e)},_allDistMargin:function(t,i,n,e){t.children.sort(e);var r,a,s=this.toBBox,l=h(t,0,i,s),f=h(t,n-i,n,s),c=u(l)+u(f);for(r=i;r<n-i;r++)a=t.children[r],o(l,t.leaf?s(a):a),c+=u(l);for(r=n-i-1;r>=i;r--)a=t.children[r],o(f,t.leaf?s(a):a),c+=u(f);return c},_adjustParentBBoxes:function(t,i,n){for(var e=n;e>=0;e--)o(i[e],t)},_condense:function(t){for(var i,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(i=t[n-1].children,i.splice(i.indexOf(t[n]),1)):this.clear():a(t[n],this.toBBox)},_initFormat:function(t){var i=["return a"," - b",";"];this.compareMinX=new Function("a","b",i.join(t[0])),this.compareMinY=new Function("a","b",i.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}}},{quickselect:2}],2:[function(t,i,n){"use strict";function e(t,i,n,a,h){for(;a>n;){if(a-n>600){var o=a-n+1,s=i-n+1,l=Math.log(o),f=.5*Math.exp(2*l/3),u=.5*Math.sqrt(l*f*(o-f)/o)*(s-o/2<0?-1:1),c=Math.max(n,Math.floor(i-s*f/o+u)),m=Math.min(a,Math.floor(i+(o-s)*f/o+u));e(t,i,c,m,h)}var d=t[i],x=n,p=a;for(r(t,n,i),h(t[a],d)>0&&r(t,n,a);x<p;){for(r(t,x,p),x++,p--;h(t[x],d)<0;)x++;for(;h(t[p],d)>0;)p--}0===h(t[n],d)?r(t,n,p):(p++,r(t,p,a)),p<=i&&(n=p+1),i<=p&&(a=p-1)}}function r(t,i,n){var e=t[i];t[i]=t[n],t[n]=e}i.exports=e},{}]},{},[1])(1)});

(function(c){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=c();else if("function"==typeof define&&define.amd)define([],c);else{var h;h="undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?this:self:global:window,h.nipplejs=c()}})(function(){function c(){}function h(B,C){return this.identifier=C.identifier,this.position=C.position,this.frontPosition=C.frontPosition,this.collection=B,this.defaults={size:100,threshold:0.1,color:"white",fadeTime:250,dataOnly:!1,restJoystick:!0,restOpacity:0.5,mode:"dynamic",zone:document.body,lockX:!1,lockY:!1},this.config(C),"dynamic"===this.options.mode&&(this.options.restOpacity=0),this.id=h.id,h.id+=1,this.buildEl().stylize(),this.instance={el:this.ui.el,on:this.on.bind(this),off:this.off.bind(this),show:this.show.bind(this),hide:this.hide.bind(this),add:this.addToDom.bind(this),remove:this.removeFromDom.bind(this),destroy:this.destroy.bind(this),resetDirection:this.resetDirection.bind(this),computeDirection:this.computeDirection.bind(this),trigger:this.trigger.bind(this),position:this.position,frontPosition:this.frontPosition,ui:this.ui,identifier:this.identifier,id:this.id,options:this.options},this.instance}function k(B,C){var D=this;return D.nipples=[],D.idles=[],D.actives=[],D.ids=[],D.pressureIntervals={},D.manager=B,D.id=k.id,k.id+=1,D.defaults={zone:document.body,multitouch:!1,maxNumberOfNipples:10,mode:"dynamic",position:{top:0,left:0},catchDistance:200,size:100,threshold:0.1,color:"white",fadeTime:250,dataOnly:!1,restJoystick:!0,restOpacity:0.5,lockX:!1,lockY:!1},D.config(C),("static"===D.options.mode||"semi"===D.options.mode)&&(D.options.multitouch=!1),D.options.multitouch||(D.options.maxNumberOfNipples=1),D.updateBox(),D.prepareNipples(),D.bindings(),D.begin(),D.nipples}function l(B){var C=this;C.ids={},C.index=0,C.collections=[],C.config(B),C.prepareCollections();var D;return z.bindEvt(window,"resize",function(){clearTimeout(D),D=setTimeout(function(){var F,G=z.getScroll();C.collections.forEach(function(H){H.forEach(function(I){F=I.el.getBoundingClientRect(),I.position={x:G.x+F.left,y:G.y+F.top}})})},100)}),C.collections}var q=!!("ontouchstart"in window),r=!!window.PointerEvent,s=!!window.MSPointerEvent,t={touch:{start:"touchstart",move:"touchmove",end:"touchend, touchcancel"},mouse:{start:"mousedown",move:"mousemove",end:"mouseup"},pointer:{start:"pointerdown",move:"pointermove",end:"pointerup, pointercancel"},MSPointer:{start:"MSPointerDown",move:"MSPointerMove",end:"MSPointerUp"}},v,w={};r?v=t.pointer:s?v=t.MSPointer:q?(v=t.touch,w=t.mouse):v=t.mouse;var z={};z.distance=function(B,C){var D=C.x-B.x,E=C.y-B.y;return Math.sqrt(D*D+E*E)},z.angle=function(B,C){var D=C.x-B.x,E=C.y-B.y;return z.degrees(Math.atan2(E,D))},z.findCoord=function(B,C,D){var E={x:0,y:0};return D=z.radians(D),E.x=B.x-C*Math.cos(D),E.y=B.y-C*Math.sin(D),E},z.radians=function(B){return B*(Math.PI/180)},z.degrees=function(B){return B*(180/Math.PI)},z.bindEvt=function(B,C,D){for(var F,E=C.split(/[ ,]+/g),G=0;G<E.length;G+=1)F=E[G],B.addEventListener?B.addEventListener(F,D,!1):B.attachEvent&&B.attachEvent(F,D)},z.unbindEvt=function(B,C,D){for(var F,E=C.split(/[ ,]+/g),G=0;G<E.length;G+=1)F=E[G],B.removeEventListener?B.removeEventListener(F,D):B.detachEvent&&B.detachEvent(F,D)},z.trigger=function(B,C,D){var E=new CustomEvent(C,D);B.dispatchEvent(E)},z.prepareEvent=function(B){return B.preventDefault(),B.type.match(/^touch/)?B.changedTouches:B},z.getScroll=function(){var B=window.pageXOffset===void 0?(document.documentElement||document.body.parentNode||document.body).scrollLeft:window.pageXOffset,C=window.pageYOffset===void 0?(document.documentElement||document.body.parentNode||document.body).scrollTop:window.pageYOffset;return{x:B,y:C}},z.applyPosition=function(B,C){C.top||C.right||C.bottom||C.left?(B.style.top=C.top,B.style.right=C.right,B.style.bottom=C.bottom,B.style.left=C.left):(B.style.left=C.x+"px",B.style.top=C.y+"px")},z.getTransitionStyle=function(B,C,D){var E=z.configStylePropertyObject(B);for(var F in E)if(E.hasOwnProperty(F))if("string"==typeof C)E[F]=C+" "+D;else{for(var G="",H=0,I=C.length;H<I;H+=1)G+=C[H]+" "+D+", ";E[F]=G.slice(0,-2)}return E},z.getVendorStyle=function(B,C){var D=z.configStylePropertyObject(B);for(var E in D)D.hasOwnProperty(E)&&(D[E]=C);return D},z.configStylePropertyObject=function(B){var C={};C[B]="";return["webkit","Moz","o"].forEach(function(E){C[E+B.charAt(0).toUpperCase()+B.slice(1)]=""}),C},z.extend=function(B,C){for(var D in C)C.hasOwnProperty(D)&&(B[D]=C[D]);return B},z.safeExtend=function(B,C){var D={};for(var E in B)B.hasOwnProperty(E)&&C.hasOwnProperty(E)?D[E]=C[E]:B.hasOwnProperty(E)&&(D[E]=B[E]);return D},z.map=function(B,C){if(B.length)for(var D=0,E=B.length;D<E;D+=1)C(B[D]);else C(B)};c.prototype.on=function(B,C){var D=this,E=B.split(/[ ,]+/g),F;D._handlers_=D._handlers_||{};for(var G=0;G<E.length;G+=1)F=E[G],D._handlers_[F]=D._handlers_[F]||[],D._handlers_[F].push(C);return D},c.prototype.off=function(B,C){var D=this;return D._handlers_=D._handlers_||{},void 0===B?D._handlers_={}:void 0===C?D._handlers_[B]=null:D._handlers_[B]&&0<=D._handlers_[B].indexOf(C)&&D._handlers_[B].splice(D._handlers_[B].indexOf(C),1),D},c.prototype.trigger=function(B,C){var D=this,E=B.split(/[ ,]+/g),F;D._handlers_=D._handlers_||{};for(var G=0;G<E.length;G+=1)F=E[G],D._handlers_[F]&&D._handlers_[F].length&&D._handlers_[F].forEach(function(H){H.call(D,{type:F,target:D},C)})},c.prototype.config=function(B){var C=this;C.options=C.defaults||{},B&&(C.options=z.safeExtend(C.options,B))},c.prototype.bindEvt=function(B,C){var D=this;return D._domHandlers_=D._domHandlers_||{},D._domHandlers_[C]=function(){"function"==typeof D["on"+C]?D["on"+C].apply(D,arguments):console.warn("[WARNING] : Missing \"on"+C+"\" handler.")},z.bindEvt(B,v[C],D._domHandlers_[C]),w[C]&&z.bindEvt(B,w[C],D._domHandlers_[C]),D},c.prototype.unbindEvt=function(B,C){var D=this;return D._domHandlers_=D._domHandlers_||{},z.unbindEvt(B,v[C],D._domHandlers_[C]),w[C]&&z.unbindEvt(B,w[C],D._domHandlers_[C]),delete D._domHandlers_[C],this};h.prototype=new c,h.constructor=h,h.id=0,h.prototype.buildEl=function(){return(this.ui={},this.options.dataOnly)?this:(this.ui.el=document.createElement("div"),this.ui.back=document.createElement("div"),this.ui.front=document.createElement("div"),this.ui.el.className="nipple collection_"+this.collection.id,this.ui.back.className="back",this.ui.front.className="front",this.ui.el.setAttribute("id","nipple_"+this.collection.id+"_"+this.id),this.ui.el.appendChild(this.ui.back),this.ui.el.appendChild(this.ui.front),this)},h.prototype.stylize=function(){if(this.options.dataOnly)return this;var B=this.options.fadeTime+"ms",C=z.getVendorStyle("borderRadius","50%"),D=z.getTransitionStyle("transition","opacity",B),E={};return E.el={position:"absolute",opacity:this.options.restOpacity,display:"block",zIndex:999},E.back={position:"absolute",display:"block",width:this.options.size+"px",height:this.options.size+"px",marginLeft:-this.options.size/2+"px",marginTop:-this.options.size/2+"px",background:this.options.color,opacity:".5"},E.front={width:this.options.size/2+"px",height:this.options.size/2+"px",position:"absolute",display:"block",marginLeft:-this.options.size/4+"px",marginTop:-this.options.size/4+"px",background:this.options.color,opacity:".5"},z.extend(E.el,D),z.extend(E.back,C),z.extend(E.front,C),this.applyStyles(E),this},h.prototype.applyStyles=function(B){for(var C in this.ui)if(this.ui.hasOwnProperty(C))for(var D in B[C])this.ui[C].style[D]=B[C][D];return this},h.prototype.addToDom=function(){return this.options.dataOnly||document.body.contains(this.ui.el)?this:(this.options.zone.appendChild(this.ui.el),this)},h.prototype.removeFromDom=function(){return this.options.dataOnly||!document.body.contains(this.ui.el)?this:(this.options.zone.removeChild(this.ui.el),this)},h.prototype.destroy=function(){clearTimeout(this.removeTimeout),clearTimeout(this.showTimeout),clearTimeout(this.restTimeout),this.trigger("destroyed",this.instance),this.removeFromDom(),this.off()},h.prototype.show=function(B){var C=this;return C.options.dataOnly?C:(clearTimeout(C.removeTimeout),clearTimeout(C.showTimeout),clearTimeout(C.restTimeout),C.addToDom(),C.restCallback(),setTimeout(function(){C.ui.el.style.opacity=1},0),C.showTimeout=setTimeout(function(){C.trigger("shown",C.instance),"function"==typeof B&&B.call(this)},C.options.fadeTime),C)},h.prototype.hide=function(B){var C=this;return C.options.dataOnly?C:(C.ui.el.style.opacity=C.options.restOpacity,clearTimeout(C.removeTimeout),clearTimeout(C.showTimeout),clearTimeout(C.restTimeout),C.removeTimeout=setTimeout(function(){var D="dynamic"===C.options.mode?"none":"block";C.ui.el.style.display=D,"function"==typeof B&&B.call(C),C.trigger("hidden",C.instance)},C.options.fadeTime),C.options.restJoystick&&C.restPosition(),C)},h.prototype.restPosition=function(B){var C=this;C.frontPosition={x:0,y:0};var D=C.options.fadeTime+"ms",E={};E.front=z.getTransitionStyle("transition",["top","left"],D);var F={front:{}};F.front={left:C.frontPosition.x+"px",top:C.frontPosition.y+"px"},C.applyStyles(E),C.applyStyles(F),C.restTimeout=setTimeout(function(){"function"==typeof B&&B.call(C),C.restCallback()},C.options.fadeTime)},h.prototype.restCallback=function(){var B=this,C={};C.front=z.getTransitionStyle("transition","none",""),B.applyStyles(C),B.trigger("rested",B.instance)},h.prototype.resetDirection=function(){this.direction={x:!1,y:!1,angle:!1}},h.prototype.computeDirection=function(B){var F,G,H,C=B.angle.radian,D=Math.PI/4,E=Math.PI/2;if(C>D&&C<3*D&&!B.lockX?F="up":C>-D&&C<=D&&!B.lockY?F="left":C>3*-D&&C<=-D&&!B.lockX?F="down":!B.lockY&&(F="right"),B.lockY||(C>-E&&C<E?G="left":G="right"),B.lockX||(0<C?H="up":H="down"),B.force>this.options.threshold){var I={};for(var J in this.direction)this.direction.hasOwnProperty(J)&&(I[J]=this.direction[J]);var K={};for(var J in this.direction={x:G,y:H,angle:F},B.direction=this.direction,I)I[J]===this.direction[J]&&(K[J]=!0);if(K.x&&K.y&&K.angle)return B;K.x&&K.y||this.trigger("plain",B),K.x||this.trigger("plain:"+G,B),K.y||this.trigger("plain:"+H,B),K.angle||this.trigger("dir dir:"+F,B)}return B},k.prototype=new c,k.constructor=k,k.id=0,k.prototype.prepareNipples=function(){var B=this,C=B.nipples;C.on=B.on.bind(B),C.off=B.off.bind(B),C.options=B.options,C.destroy=B.destroy.bind(B),C.ids=B.ids,C.id=B.id,C.processOnMove=B.processOnMove.bind(B),C.processOnEnd=B.processOnEnd.bind(B),C.get=function(D){if(D===void 0)return C[0];for(var E=0,F=C.length;E<F;E+=1)if(C[E].identifier===D)return C[E];return!1}},k.prototype.bindings=function(){var B=this;B.bindEvt(B.options.zone,"start"),B.options.zone.style.touchAction="none",B.options.zone.style.msTouchAction="none"},k.prototype.begin=function(){var B=this,C=B.options;if("static"===C.mode){var D=B.createNipple(C.position,B.manager.getIdentifier());D.add(),B.idles.push(D)}},k.prototype.createNipple=function(B,C){var D=this,E=z.getScroll(),F={},G=D.options;if(B.x&&B.y)F={x:B.x-(E.x+D.box.left),y:B.y-(E.y+D.box.top)};else if(B.top||B.right||B.bottom||B.left){var H=document.createElement("DIV");H.style.display="hidden",H.style.top=B.top,H.style.right=B.right,H.style.bottom=B.bottom,H.style.left=B.left,H.style.position="absolute",G.zone.appendChild(H);var I=H.getBoundingClientRect();G.zone.removeChild(H),F=B,B={x:I.left+E.x,y:I.top+E.y}}var J=new h(D,{color:G.color,size:G.size,threshold:G.threshold,fadeTime:G.fadeTime,dataOnly:G.dataOnly,restJoystick:G.restJoystick,restOpacity:G.restOpacity,mode:G.mode,identifier:C,position:B,zone:G.zone,frontPosition:{x:0,y:0}});return G.dataOnly||(z.applyPosition(J.ui.el,F),z.applyPosition(J.ui.front,J.frontPosition)),D.nipples.push(J),D.trigger("added "+J.identifier+":added",J),D.manager.trigger("added "+J.identifier+":added",J),D.bindNipple(J),J},k.prototype.updateBox=function(){var B=this;B.box=B.options.zone.getBoundingClientRect()},k.prototype.bindNipple=function(B){var C=this,D,E=function(F,G){D=F.type+" "+G.id+":"+F.type,C.trigger(D,G)};B.on("destroyed",C.onDestroyed.bind(C)),B.on("shown hidden rested dir plain",E),B.on("dir:up dir:right dir:down dir:left",E),B.on("plain:up plain:right plain:down plain:left",E)},k.prototype.pressureFn=function(B,C,D){var E=this,F=0;clearInterval(E.pressureIntervals[D]),E.pressureIntervals[D]=setInterval(function(){var G=B.force||B.pressure||B.webkitForce||0;G!==F&&(C.trigger("pressure",G),E.trigger("pressure "+C.identifier+":pressure",G),F=G)}.bind(E),100)},k.prototype.onstart=function(B){var C=this,D=C.options;B=z.prepareEvent(B),C.updateBox();return z.map(B,function(F){C.actives.length<D.maxNumberOfNipples&&C.processOnStart(F)}),C.manager.bindDocument(),!1},k.prototype.processOnStart=function(B){var E,C=this,D=C.options,F=C.manager.getIdentifier(B),G=B.force||B.pressure||B.webkitForce||0,H={x:B.pageX,y:B.pageY},I=C.getOrCreate(F,H);I.identifier!==F&&C.manager.removeIdentifier(I.identifier),I.identifier=F;var J=function(L){L.trigger("start",L),C.trigger("start "+L.id+":start",L),L.show(),0<G&&C.pressureFn(B,L,L.identifier),C.processOnMove(B)};if(0<=(E=C.idles.indexOf(I))&&C.idles.splice(E,1),C.actives.push(I),C.ids.push(I.identifier),"semi"!==D.mode)J(I);else{var K=z.distance(H,I.position);if(K<=D.catchDistance)J(I);else return I.destroy(),void C.processOnStart(B)}return I},k.prototype.getOrCreate=function(B,C){var F,D=this,E=D.options;return /(semi|static)/.test(E.mode)?(F=D.idles[0],F)?(D.idles.splice(0,1),F):"semi"===E.mode?D.createNipple(C,B):(console.warn("Coudln't find the needed nipple."),!1):(F=D.createNipple(C,B),F)},k.prototype.processOnMove=function(B){var C=this,D=C.options,E=C.manager.getIdentifier(B),F=C.nipples.get(E);if(!F)return console.error("Found zombie joystick with ID "+E),void C.manager.removeIdentifier(E);F.identifier=E;var G=F.options.size/2,H={x:B.pageX,y:B.pageY},I=z.distance(H,F.position),J=z.angle(H,F.position),K=z.radians(J),L=I/G;I>G&&(I=G,H=z.findCoord(F.position,I,J));var M=H.x-F.position.x,N=H.y-F.position.y;D.lockX&&(N=0),D.lockY&&(M=0),F.frontPosition={x:M,y:N},D.dataOnly||z.applyPosition(F.ui.front,F.frontPosition);var O={identifier:F.identifier,position:H,force:L,pressure:B.force||B.pressure||B.webkitForce||0,distance:I,angle:{radian:K,degree:J},instance:F,lockX:D.lockX,lockY:D.lockY};O=F.computeDirection(O),O.angle={radian:z.radians(180-J),degree:180-J},F.trigger("move",O),C.trigger("move "+F.id+":move",O)},k.prototype.processOnEnd=function(B){var C=this,D=C.options,E=C.manager.getIdentifier(B),F=C.nipples.get(E),G=C.manager.removeIdentifier(F.identifier);F&&(!D.dataOnly&&F.hide(function(){"dynamic"===D.mode&&(F.trigger("removed",F),C.trigger("removed "+F.id+":removed",F),C.manager.trigger("removed "+F.id+":removed",F),F.destroy())}),clearInterval(C.pressureIntervals[F.identifier]),F.resetDirection(),F.trigger("end",F),C.trigger("end "+F.id+":end",F),0<=C.ids.indexOf(F.identifier)&&C.ids.splice(C.ids.indexOf(F.identifier),1),0<=C.actives.indexOf(F)&&C.actives.splice(C.actives.indexOf(F),1),/(semi|static)/.test(D.mode)?C.idles.push(F):0<=C.nipples.indexOf(F)&&C.nipples.splice(C.nipples.indexOf(F),1),C.manager.unbindDocument(),/(semi|static)/.test(D.mode)&&(C.manager.ids[G.id]=G.identifier))},k.prototype.onDestroyed=function(B,C){var D=this;0<=D.nipples.indexOf(C)&&D.nipples.splice(D.nipples.indexOf(C),1),0<=D.actives.indexOf(C)&&D.actives.splice(D.actives.indexOf(C),1),0<=D.idles.indexOf(C)&&D.idles.splice(D.idles.indexOf(C),1),0<=D.ids.indexOf(C.identifier)&&D.ids.splice(D.ids.indexOf(C.identifier),1),D.manager.removeIdentifier(C.identifier),D.manager.unbindDocument()},k.prototype.destroy=function(){var B=this;for(var C in B.unbindEvt(B.options.zone,"start"),B.nipples.forEach(function(D){D.destroy()}),B.pressureIntervals)B.pressureIntervals.hasOwnProperty(C)&&clearInterval(B.pressureIntervals[C]);B.trigger("destroyed",B.nipples),B.manager.unbindDocument(),B.off()};l.prototype=new c,l.constructor=l,l.prototype.prepareCollections=function(){var B=this;B.collections.create=B.create.bind(B),B.collections.on=B.on.bind(B),B.collections.off=B.off.bind(B),B.collections.destroy=B.destroy.bind(B),B.collections.get=function(C){var D;return B.collections.every(function(E){return!(D=E.get(C))}),D}},l.prototype.create=function(B){return this.createCollection(B)},l.prototype.createCollection=function(B){var C=this,D=new k(C,B);return C.bindCollection(D),C.collections.push(D),D},l.prototype.bindCollection=function(B){var C=this,D,E=function(F,G){D=F.type+" "+G.id+":"+F.type,C.trigger(D,G)};B.on("destroyed",C.onDestroyed.bind(C)),B.on("shown hidden rested dir plain",E),B.on("dir:up dir:right dir:down dir:left",E),B.on("plain:up plain:right plain:down plain:left",E)},l.prototype.bindDocument=function(){var B=this;B.binded||(B.bindEvt(document,"move").bindEvt(document,"end"),B.binded=!0)},l.prototype.unbindDocument=function(B){var C=this;Object.keys(C.ids).length&&!0!==B||(C.unbindEvt(document,"move").unbindEvt(document,"end"),C.binded=!1)},l.prototype.getIdentifier=function(B){var C;return B?(C=void 0===B.identifier?B.pointerId:B.identifier,void 0==C&&(C=this.latest||0)):C=this.index,void 0===this.ids[C]&&(this.ids[C]=this.index,this.index+=1),this.latest=C,this.ids[C]},l.prototype.removeIdentifier=function(B){var C={};for(var D in this.ids)if(this.ids[D]===B){C.id=D,C.identifier=this.ids[D],delete this.ids[D];break}return C},l.prototype.onmove=function(B){var C=this;return C.onAny("move",B),!1},l.prototype.onend=function(B){var C=this;return C.onAny("end",B),!1},l.prototype.oncancel=function(B){var C=this;return C.onAny("end",B),!1},l.prototype.onAny=function(B,C){var E,D=this,F="processOn"+B.charAt(0).toUpperCase()+B.slice(1);C=z.prepareEvent(C);var G=function(I,J,K){0<=K.ids.indexOf(J)&&(K[F](I),I._found_=!0)};return z.map(C,function(I){E=D.getIdentifier(I),z.map(D.collections,G.bind(null,I,E)),I._found_||D.removeIdentifier(E)}),!1},l.prototype.destroy=function(){var B=this;B.unbindDocument(!0),B.ids={},B.index=0,B.collections.forEach(function(C){C.destroy()}),B.off()},l.prototype.onDestroyed=function(B,C){var D=this;return!(0>D.collections.indexOf(C))&&void D.collections.splice(D.collections.indexOf(C),1)};var A=new l;return{create:function(B){return A.create(B)},factory:A}});